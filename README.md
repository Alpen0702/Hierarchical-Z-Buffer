# Hierarchical Z-Buffer
这里是2022秋-计算机图形学的课程作业：使用扫描线z-buffer和层次z-buffer算法实现深度消隐。<br><br>
## 程序结构
为了比较各种消隐算法的效率，并且将各算法明显区分开来方便阅读，本项目基本将每个算法的代码各自放置于一个源文件中。<br><br>
**main.cpp**是本项目的主程序。在主程序中，首先选择用于测试的OBJ模型。在这里，我们准备了四个大小不同的模型供选择，默认使用hut_t.obj。选择模型后，主程序会调用**readOBJ.cpp**和**adjustOBJ.cpp**来读取OBJ文件，并将其调整到与窗口合适的大小。<br><br>
完成OBJ文件的读取和调整后，主程序将对OpenGL进行初始化，然后依次调用四个深度消隐函数来实现不同算法对模型的消隐和呈现。每个深度消隐函数都会创建一个新的图形窗口，并以线框图的形式显示其渲染结果。关闭上一个图形窗口后，下一个深度消隐函数才会开始运行。（本来是想同时在一个窗口中分屏显示四个深度消隐函数的结果的，但考虑到要比较fps，故让机器每次专注于一个算法，然后依次显示）<br><br>
四个深度消隐函数都结束后，主程序会调用**summary.cpp**来生成一份总结报告，包括每个深度消隐函数的运行时间、绘制帧数和fps。可以利用这些数据来计算不同算法间的加速比。<br><br>
下面是主程序调用的四个深度消隐函数的主要结构及功能概述：<br><br>
### 不使用z-buffer
**NoneZBuffer.cpp**是第一个运行的渲染子程序。它会建立一个"None Z-Buffer"窗口，并显示不使用任何消隐算法、而是直接绘制面片的渲染结果。因此，其渲染出的线框图会出现前后相互重叠的现象。<br><br>
具体而言，渲染函数首先将背景铺为白色，然后调用**NrasterizeTriangle**函数遍历面片；在每个面片中，又调用**NrasterizeLine**函数，从每条线段的上端点到下端点遍历y值，并依照斜率计算对应的x值，以逐行进行光栅化。<br><br>
### 扫描线z-buffer
**ScanlineZBuffer.cpp**是第二个运行的渲染子程序。它会建立一个"Scanline Z-Buffer"窗口，并显示使用扫描线z-buffer算法消隐后得到的渲染结果。<br><br>
扫描线z-buffer算法会在每一帧的开头调用**genTables**函数，根据边和三角形面片的最大y值来建立分类边表、三角形表和活化边表。然后，它会从最大的y值开始逐行向下扫描，将扫描到的新三角形中的边加入活化边表，然后利用面片的连续性，增量式地计算出同一行下一个x值处的面片深度，并依次更新深度缓冲实现消隐。随着扫描线的推进，过期的三角形面片和边会从活化表中移除。由于每次只会进行一行像素的渲染，因此其深度缓冲区可以不使用二维数组而是使用一维数组，从而节省空间。<br><br>
不过，在实际的编程操作中，我们发现，对边和三角形建表后逐行扫描对时间的消耗很大，而其使用一维数组节省的空间对于正常尺寸的显示屏而言并不算重要。在本项目中，主要的限制因素是时间而非空间。因此，在version 1.1以后的**ScanlineZBuffer.cpp**中，我们舍弃了建表逐行扫描的办法，而是选择对每个三角形面片直接进行扫描。具体而言，在**SrasterizeTriangle**函数中，我们将每个三角形横切为上下两个小三角形，小三角形均为平顶或平底，方便扫描线运作。然后，与原方法类似地光栅化上下两个小三角形，并将深度信息存储到二维而非一维的深度缓冲区中，如此遍历每个三角形面片，以获得整体的光栅化结果。<br><br>
当前的**ScanlineZBuffer.cpp**中，仍在注释中保留了一维深度缓冲的经典扫描线z-buffer算法以供参考。您也可以查看项目历史版本中的首次提交以查阅经典扫描线z-buffer算法的实现。<br><br>
### 简单层次z-buffer

### 层次z-buffer
<br><br><br><br>
需要指出的是，以上四个消隐子程序都并非直接使用OpenGL绘制线段和面片，而是将需要绘制的像素的RGB信息存储在pixels[][]数组中，待一帧中的所有面片消隐全部结束后，再将pixels[][]数组投射到一个正方形的布满屏幕的纹理上，最后一次性在屏幕上绘制一个带有该纹理的布满屏幕的正方形，从而实现延迟渲染。<br><br>
此外，在深度消隐的每一帧，消隐函数都会调用**adjustOBJ.cpp**中的**rotate**函数，将模型进行旋转。注意，视点始终没有改动。<br><br>
## 使用说明
## 讨论与反思
## 联系作者
代码几乎全是自己照着冯老师的ppt手写的，连Reference都没怎么参考（所以才写得那么烂吧QAQ），不过要特别感谢ChatGPT在debug中对我的帮助。有任何问题，欢迎通过llzju@zju.edu.cn联系我。<br><br>
